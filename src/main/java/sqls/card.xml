<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  

  
<mapper namespace="com.decolab.wanza.dao.CardDAO">


<!-- 스토리 글 목록 가져오기 -->
<select id="getCardList" resultType="com.decolab.wanza.dto.CardDTO">
	SELECT C.CARDSEQ, C.CARDTITLE, C.CARDCONTENT, U.USERSEQ, C.CARDREADCOUNT, C.CARDDATE, CARDFILENAME, CARDDEL, U.NICKNAME, F.LIKECOUNT  
	FROM USERS U, CARD_COLLECTIONS C, (SELECT CARDSEQ, NVL(COUNT(*), 0) LIKECOUNT FROM CARD_FAVORITE GROUP BY CARDSEQ) F
	WHERE U.USERSEQ=C.USERSEQ AND C.CARDSEQ=F.CARDSEQ(+) AND CARDDEL=0
	ORDER BY C.CARDDATE DESC
</select>

<!-- 스토리 글 검색해서 가져오기 -->
<select id="getSearchCard" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
	SELECT C.CARDSEQ, C.CARDTITLE, C.CARDCONTENT, U.USERSEQ, C.CARDREADCOUNT, C.CARDDATE, CARDFILENAME, CARDDEL, U.NICKNAME, F.LIKECOUNT  
	FROM USERS U, CARD_COLLECTIONS C, (SELECT CARDSEQ, NVL(COUNT(*), 0) LIKECOUNT FROM CARD_FAVORITE GROUP BY CARDSEQ) F
	WHERE U.USERSEQ=C.USERSEQ AND C.CARDSEQ=F.CARDSEQ(+) AND CARDTITLE LIKE'%'||#{cardTitle}||'%' AND CARDDEL=0
	ORDER BY F.LIKECOUNT DESC NULLS LAST
</select>

<!-- 스토리 글 정렬해서 가져오기 -->
<select id="getCardSortList" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
   SELECT * FROM(
   SELECT C.CARDSEQ, C.CARDTITLE, C.CARDCONTENT, U.USERSEQ, C.CARDREADCOUNT, C.CARDDATE, CARDFILENAME, CARDDEL, U.NICKNAME, NVL(F.LIKECOUNT,0) LIKECOUNT,
   NVL(T.TAGCOLOR,' ') TAGCOLOR, NVL(T.TAGHOMETYPE,' ') TAGHOMETYPE, NVL(T.TAGSTYLE,' ') TAGSTYLE
   FROM USERS U, CARD_COLLECTIONS C, (SELECT CARDSEQ, NVL(COUNT(*), 0) LIKECOUNT FROM CARD_FAVORITE GROUP BY CARDSEQ) F, CARD_TAG T
   WHERE U.USERSEQ=C.USERSEQ AND C.CARDSEQ=F.CARDSEQ(+) AND C.CARDSEQ=T.CARDSEQ(+) AND CARDDEL=0
   <if test='tagColor neq "0" and tagColor neq null'>AND TAGCOLOR=#{tagColor} </if>
   <if test='tagHomeType neq "0" and tagHomeType neq null'>AND TAGHOMETYPE=#{tagHomeType} </if>
   <if test='tagStyle neq "0" and tagStyle neq null'>AND TAGSTYLE=#{tagStyle} </if>
   <if test='cardTitle neq "" and cardTitle neq null' >AND CARDTITLE LIKE'%'||#{cardTitle}||'%'</if>
   <choose>
      <when test="sort eq 1"> ORDER BY C.CARDDATE DESC</when>
      <when test="sort eq 2"> ORDER BY C.CARDREADCOUNT DESC</when>
      <otherwise> ORDER BY F.LIKECOUNT DESC NULLS LAST, C.CARDREADCOUNT DESC</otherwise>
   </choose>
   )<if test='cardDel neq "0" and cardDel neq null'>WHERE ROWNUM &lt;= #{cardDel}</if>
</select>

<!-- 스토리 글 작성 -->
<insert id="cardWrite" parameterType="com.decolab.wanza.dto.CardDTO">
	INSERT INTO CARD_COLLECTIONS
	VALUES (SEQ_CARD.NEXTVAL, #{cardTitle}, #{cardContent}, #{userSeq}, 0, SYSDATE, #{cardFileName}, 0)
</insert>
  
  
<!-- 스토리 디테일 가져오기 -->
<select id="getCardDetail" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
	SELECT C.CARDSEQ, CARDTITLE, CARDCONTENT, U.USERSEQ, CARDREADCOUNT, CARDDATE, CARDFILENAME, CARDDEL, U.NICKNAME,
        T.TAGCOLOR, T.TAGHOMETYPE, T.TAGSTYLE
	FROM USERS U, CARD_COLLECTIONS C, CARD_TAG T
	WHERE U.USERSEQ = C.USERSEQ AND C.CARDSEQ = T.CARDSEQ AND C.CARDSEQ=#{cardSeq}
</select>

<!-- 유저의 다른 사진 가져오기  -->
<select id="otherPictures" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
SELECT CARDSEQ, CARDTITLE, CARDCONTENT, USERSEQ, CARDREADCOUNT,CARDDATE,CARDFILENAME,CARDDEL
FROM(SELECT CARDSEQ, CARDTITLE, CARDCONTENT, USERSEQ, CARDREADCOUNT,CARDDATE,CARDFILENAME,CARDDEL FROM CARD_COLLECTIONS)
WHERE USERSEQ = #{userSeq} AND 4 >= ROWNUM AND CARDDEL=0 AND CARDSEQ NOT IN (#{cardSeq})
ORDER BY CARDDATE DESC
</select>

<!-- 비슷한 글 가져오기 -->
<select id="getSimilarCardList" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
SELECT C.CARDSEQ, C.CARDFILENAME
FROM CARD_COLLECTIONS C, CARD_TAG T
WHERE T.CARDSEQ NOT IN (#{cardSeq}) AND C.CARDSEQ = T.CARDSEQ AND C.CARDDEL=0
    AND (
    (TAGCOLOR=#{tagColor} AND TAGHOMETYPE=#{tagHomeType} AND TAGSTYLE=#{tagStyle})
    OR(TAGCOLOR=#{tagColor} AND TAGHOMETYPE=#{tagHomeType})
    OR (TAGHOMETYPE=#{tagHomeType} AND TAGSTYLE=#{tagStyle})
    OR (TAGCOLOR=#{tagColor} AND TAGSTYLE=#{tagStyle})
    )
</select>


<!-- cardSeq 가져오기 -->
<select id="getCardSeq" parameterType="com.decolab.wanza.dto.CardDTO" resultType="int">
	SELECT CARDSEQ
	FROM (SELECT * FROM CARD_COLLECTIONS WHERE USERSEQ=#{userSeq} ORDER BY CARDDATE DESC)
	WHERE ROWNUM=1
</select>

<!-- 카드 태그 삽입 -->
<insert id="addCardTag" parameterType="com.decolab.wanza.dto.CardDTO">
	INSERT INTO CARD_TAG
	VALUES(#{cardSeq}, #{tagColor}, #{tagHomeType}, #{tagStyle})
</insert>
  
  
<!-- 카드 삭제 -->
<update id="cardDelete" parameterType="com.decolab.wanza.dto.CardDTO">
	UPDATE CARD_COLLECTIONS
	SET CARDDEL=1
	WHERE USERSEQ=#{userSeq} AND CARDSEQ=#{cardSeq}
</update>  
  
 
<!-- 카드 수정 -->
<update id="cardUpdate" parameterType="com.decolab.wanza.dto.CardDTO">
	UPDATE CARD_COLLECTIONS
	SET CARDTITLE=#{cardTitle}, CARDCONTENT=#{cardContent}
	WHERE USERSEQ=#{userSeq} AND CARDSEQ=#{cardSeq}
</update>
<update id="cardTagUpdate" parameterType="com.decolab.wanza.dto.CardDTO">
	UPDATE CARD_TAG
	SET TAGCOLOR=#{tagColor}, TAGHOMETYPE=#{tagHomeType}, TAGSTYLE=#{tagStyle}
	WHERE CARDSEQ=#{cardSeq}
</update>
  
  
  
<!-- 조회수 1 증가 -->  
<insert id="addCardReadCount" parameterType="com.decolab.wanza.dto.CardDTO">
	UPDATE CARD_COLLECTIONS
	SET CARDREADCOUNT=CARDREADCOUNT+1
	WHERE CARDSEQ=#{cardSeq}
</insert> 

  
  
<!-- 하트 총 개수 -->  
<select id="getLikeCount" parameterType="com.decolab.wanza.dto.CardDTO" resultType="int">
	SELECT NVL(COUNT(*), 0)
	FROM CARD_FAVORITE
	WHERE CARDSEQ=#{cardSeq}
</select>    
  
<!-- 하트 누른 게시글인지 조회 -->
<select id="boolLike" parameterType="com.decolab.wanza.dto.CardDTO" resultType="int">
	SELECT NVL(COUNT(*), 0)
	FROM CARD_FAVORITE
	WHERE USERSEQ=#{userSeq} AND CARDSEQ=#{cardSeq}
</select>   

<!-- 하트 누름(+1) -->  
<insert id="addCardLikeCount" parameterType="com.decolab.wanza.dto.CardDTO">
	INSERT INTO CARD_FAVORITE
	VALUES (#{userSeq}, #{cardSeq})
</insert>   
  
<!-- 하트 취소 (-1) -->  
<delete id="deleteCardLikeCount" parameterType="com.decolab.wanza.dto.CardDTO">
	DELETE FROM CARD_FAVORITE
	WHERE USERSEQ=#{userSeq} AND CARDSEQ=#{cardSeq}
</delete>     
  
  
  
  
 
<!-- 댓글 가져온다 -->
<select id="getCardReviewList" parameterType="com.decolab.wanza.dto.CardReviewDTO" resultType="com.decolab.wanza.dto.CardReviewDTO">
	SELECT CARDREVSEQ, CARDSEQ, U.USERSEQ, NICKNAME, CARDREVCONTENT, CARDREVDATE, CARDREVDEL, PROFILENAME 
	FROM (SELECT ROW_NUMBER()OVER(ORDER BY CARDREVSEQ DESC) AS RNUM, CARDREVSEQ, CARDSEQ, USERSEQ, CARDREVCONTENT, CARDREVDATE, CARDREVDEL FROM CARD_REVIEW WHERE CARDSEQ=#{cardSeq} AND CARDREVDEL=0) R,
		USERS U	
	WHERE R.USERSEQ=U.USERSEQ AND RNUM&gt;=1+4*#{cardRevPageNum} AND RNUM&lt;=4+4*#{cardRevPageNum}
</select>  

<!-- 댓글 총 개수 -->
<select id="getCardReviewCount" parameterType="com.decolab.wanza.dto.CardReviewDTO" resultType="int">
	SELECT NVL(COUNT(*), 0)
	FROM CARD_REVIEW
	WHERE CARDSEQ=#{cardSeq} AND CARDREVDEL = 0
</select>

<!-- 댓글 작성 -->
<insert id="cardReviewWrite" parameterType="com.decolab.wanza.dto.CardReviewDTO">
	INSERT INTO CARD_REVIEW
	VALUES (SEQ_REVIEW_CARD.NEXTVAL, #{cardSeq}, #{userSeq}, #{cardRevContent}, SYSDATE, 0)
</insert>

<!-- 댓글 삭제 -->
<update id="cardReviewDelete" parameterType="com.decolab.wanza.dto.CardReviewDTO">
	UPDATE CARD_REVIEW
	SET CARDREVDEL=1
	WHERE CARDREVSEQ=#{cardRevSeq}
</update>

<!-- 마이 페이지 본인이 쓴 글 가져오기 -->
<select id="getMyStoryList" parameterType="com.decolab.wanza.dto.CardDTO" resultType="com.decolab.wanza.dto.CardDTO">
	SELECT C.CARDSEQ, CARDTITLE, CARDCONTENT, CARDFILENAME, CARDDATE, CARDREADCOUNT,
			TAGCOLOR, TAGHOMETYPE, TAGSTYLE, NVL(FCOUNT,0) LIKECOUNT, NVL(RCOUNT,0) SORT
	FROM CARD_COLLECTIONS C, CARD_TAG T
		 ,(SELECT CARDSEQ, COUNT(*)FCOUNT FROM CARD_FAVORITE GROUP BY CARDSEQ ORDER BY CARDSEQ) F
		 ,(SELECT CARDSEQ, COUNT(*)RCOUNT FROM CARD_REVIEW WHERE CARDREVDEL = 0 GROUP BY CARDSEQ ORDER BY CARDSEQ) R
	WHERE C.CARDSEQ = T.CARDSEQ(+) AND CARDDEL = 0 AND C.CARDSEQ = F.CARDSEQ(+) AND C.CARDSEQ = R.CARDSEQ(+)
	<if test='userSeq neq "0" and userSeq neq null'>AND USERSEQ=#{userSeq}</if>
	ORDER BY CARDDATE DESC
</select>
  
</mapper>