<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.decolab.wanza.dao.QuestionDAO">

	<!-- 질문과답변 전체 목록 가져오기 -->
	<select id="getAllQuestionList" resultType="com.decolab.wanza.dto.QuestionDTO">
		SELECT Q.QUESTIONSEQ 
			,Q.USERSEQ 
			,Q.QUESTIONTITLE 
			,Q.QUESTIONCONTENT 
			,Q.QUESTIONREADCOUNT 
			,Q.QUESTIONREGDATE 
			,Q.QUESTIONFILENAME 
			,Q.QUESTIONDEL
		   	,U.USERNAME 
		   	,U.NICKNAME 
		   	,U.PROFILENAME 
		   	,U.AUTH
		FROM QUESTION Q, USERS U
		WHERE 1=1
		AND QUESTIONDEL = 0
		AND Q.USERSEQ = U.USERSEQ
		ORDER BY QUESTIONREGDATE DESC
	</select>
	
	<!-- 질답게시판 제목 검색해서 가져오기 -->
	<select id="getSearchQuestion" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="com.decolab.wanza.dto.QuestionDTO">
		SELECT QUESTIONSEQ, QUESTIONTITLE, QUESTIONCONTENT, QUESTIONREADCOUNT, QUESTIONREGDATE, QUESTIONFILENAME, QUESTIONDEL,
	       	   Q.USERSEQ, USERNAME, NICKNAME, PROFILENAME, AUTH
		FROM QUESTION Q, USERS U
		WHERE QUESTIONDEL=0 AND Q.USERSEQ=U.USERSEQ AND (QUESTIONTITLE LIKE'%'||#{questionTitle}||'%' OR QUESTIONCONTENT LIKE'%'||#{questionTitle}||'%')
		ORDER BY QUESTIONSEQ DESC
	</select>
	
	<!-- 질답게시판 통합해서 가져오기 -->
	<select id="getQuestionList" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="com.decolab.wanza.dto.QuestionDTO">
		SELECT * FROM(
		SELECT Q.QUESTIONSEQ, Q.QUESTIONTITLE, Q.QUESTIONCONTENT, QUESTIONREADCOUNT, QUESTIONREGDATE, QUESTIONFILENAME, QUESTIONDEL,
	       	   Q.USERSEQ, USERNAME, NICKNAME, PROFILENAME, AUTH, COMENTDATE, NVL(COMENTCOUNT,0) COMENTCOUNT, ROW_NUMBER()OVER(ORDER BY QUESTIONREGDATE DESC) RNUM
		FROM QUESTION Q, USERS U,
			 (SELECT QUESTIONSEQ, MAX(QCREGDATE)COMENTDATE,COUNT(*)COMENTCOUNT FROM QUESTION_COMMENT WHERE QCDEL=0 GROUP BY QUESTIONSEQ) C
		WHERE Q.USERSEQ=U.USERSEQ AND QUESTIONDEL=0 AND Q.QUESTIONSEQ=C.QUESTIONSEQ(+)
		<if test='searchWord neq "" and searchWord neq null' >
			  AND (QUESTIONTITLE LIKE'%'||#{searchWord}||'%' OR QUESTIONCONTENT LIKE'%'||#{searchWord}||'%')
		</if>
		<choose>
			<when test='sort eq 1'>ORDER BY QUESTIONREADCOUNT DESC</when>
			<when test='sort eq 2'>ORDER BY COMENTDATE DESC NULLS LAST, QUESTIONREGDATE DESC</when>
			<when test='sort eq 3'>AND COMENTDATE IS NULL ORDER BY QUESTIONREGDATE DESC </when>
			<otherwise>ORDER BY QUESTIONREGDATE DESC</otherwise>
		</choose>
		) <if test='startPage neq "" and startPage neq null' >WHERE RNUM BETWEEN #{startPage} AND #{endPage}</if>
	</select>
	
	<!-- 질답게시판 통합해서 글의 총 수 가져오기 -->
	<select id="getQuestionCount" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="int">
		SELECT COUNT(Q.QUESTIONSEQ)
		FROM QUESTION Q,
			 (SELECT QUESTIONSEQ, MAX(QCREGDATE)COMENTDATE,COUNT(*)COMENTCOUNT FROM QUESTION_COMMENT WHERE QCDEL=0 GROUP BY QUESTIONSEQ) C
		WHERE QUESTIONDEL=0 AND Q.QUESTIONSEQ=C.QUESTIONSEQ(+)
		<if test='searchWord neq "" and searchWord neq null' >
		        AND (QUESTIONTITLE LIKE'%'||#{searchWord}||'%' OR QUESTIONCONTENT LIKE'%'||#{searchWord}||'%')
		</if>
		<if test='sort neq "" and sort neq null and sort eq 3'>AND COMENTDATE IS NULL ORDER BY QUESTIONREGDATE DESC</if>
	</select>
		
	<!-- 질문과답변 글쓰기 -->
	<insert id="questionWrite" parameterType="com.decolab.wanza.dto.QuestionDTO">
		INSERT INTO QUESTION
		VALUES(QUESTIONSEQ.NEXTVAL, #{userSeq}, #{questionTitle}, #{questionContent}, 0, SYSDATE, #{questionFileName}, 0)
	</insert>
	
	<!-- 질문과답변 디테일가져오기 
	<select id="questionDetail" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="com.decolab.wanza.dto.QuestionDTO">
		SELECT QUESTIONSEQ, QUESTIONTITLE, QUESTIONCONTENT, QUESTIONREADCOUNT, QUESTIONREGDATE, QUESTIONFILENAME, QUESTIONDEL, QUESTIONREF, QUESTIONSTEP QUESTIONDEPTH
		FROM QUESTION
		WHERE QUESTIONSEQ = #{questionSeq}
	</select>-->
	
	<!-- 질문과답변 디테일가져오기 & 유저테이블정보도 다 가져오기 -->
	<select id="questionDetail" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="com.decolab.wanza.dto.QuestionDTO">
		SELECT Q.QUESTIONSEQ 
			,Q.USERSEQ 
			,Q.QUESTIONTITLE 
			,Q.QUESTIONCONTENT 
			,Q.QUESTIONREADCOUNT 
			,Q.QUESTIONREGDATE 
			,Q.QUESTIONFILENAME 
			,Q.QUESTIONDEL
		   	,U.USERNAME 
		   	,U.NICKNAME 
		   	,U.PROFILENAME 
		   	,U.AUTH
		FROM QUESTION Q, USERS U
		WHERE 1=1
		AND Q.USERSEQ = U.USERSEQ 
		AND Q.QUESTIONSEQ = #{questionSeq}
	</select>
	
	<!-- 질문과답변 댓글리스트 가져오기 -->
	<select id="questionCommentList" parameterType="com.decolab.wanza.dto.QuestionCommentDTO" resultType="com.decolab.wanza.dto.QuestionCommentDTO">
		SELECT Q.QUESTIONSEQ
		, Q.USERSEQ
		, Q.QCSEQ
		, Q.QCCONTENT
		, Q.QCREGDATE
		, Q.QCFILENAME
		, Q.QCDEL
		, Q.QCREF
		, Q.QCSTEP
		, Q.QCDEPTH
        , U.USERNAME
        , U.NICKNAME
        , U.AUTH
        , U.PROFILENAME
		FROM QUESTION_COMMENT Q, USERS U
		WHERE 1=1 
		AND Q.USERSEQ = U.USERSEQ 
		AND Q.QCDEL = 0
		AND Q.QUESTIONSEQ = #{questionSeq}
		ORDER BY QCREF DESC, QCDEPTH, QCSTEP
	</select>
	
	<!-- 질문과답변 댓글리스트와 덧글리스트 전부 가져오기 -->
	<select id="allquestionCommentList" parameterType="com.decolab.wanza.dto.QuestionDTO" resultType="com.decolab.wanza.dto.QuestionCommentDTO">
		SELECT 
		  Q.QUESTIONSEQ
		, Q.USERSEQ
		, QC.QCSEQ
		, QC.QCCONTENT
		, QC.QCREGDATE
		, QC.QCFILENAME
		, QC.QCDEL
		, QC.QCREF
		, QC.QCSTEP
		, QC.QCDEPTH
        , U.USERNAME
        , U.NICKNAME
        , U.AUTH
        , U.PROFILENAME
		FROM QUESTION Q, USERS U, QUESTION_COMMENT QC
		WHERE 1=1 
		AND Q.USERSEQ = U.USERSEQ 
		AND Q.QUESTIONSEQ = QC.QUESTIONSEQ
		AND Q.QCDEL = 0
		AND Q.QUESTIONSEQ = #{questionSeq}
		ORDER BY QCSEQ DESC, QCREF ASC
	</select>	
	
	<!-- 질문과답변 댓글쓰기 -->
	<insert id="questionComment" parameterType="com.decolab.wanza.dto.QuestionCommentDTO">
		INSERT INTO QUESTION_COMMENT
		VALUES(
		#{questionSeq}
		, #{userSeq}
		, QCSEQ.NEXTVAL
		, #{qcContent}
		, SYSDATE
		, #{qcFileName}
		, 0
		, (SELECT NVL(MAX(QCREF)+1, 0) FROM QUESTION_COMMENT)
		, 0
		, 0)
	</insert>
	
	<!-- 질문과답변 댓글삭제 -->
	<update id="questionCommentdel" parameterType="com.decolab.wanza.dto.QuestionCommentDTO">
		UPDATE QUESTION_COMMENT
		SET QCDEL = 1
		WHERE QCSEQ = #{qcSeq}
	</update>
	
	<!-- 질문과답변 댓글숫자 세기 -->
	<select id="questionCommentCount" parameterType="com.decolab.wanza.dto.QuestionCommentDTO" resultType="int">
		SELECT NVL(COUNT(*), 0) 
		FROM QUESTION_COMMENT
		WHERE  1=1
		AND QUESTIONSEQ = #{questionSeq} AND QCDEL = 0
	</select>
	
	<!-- 질문과답변 댓글에 답글 -->
	<!-- 질문과답변 댓글에 답글달기 -->
	<insert id="questionCommentAnswer" parameterType="com.decolab.wanza.dto.QuestionCommentDTO">
		INSERT INTO QUESTION_COMMENT
		VALUES(
		#{questionSeq}
		, #{userSeq}
		, QCSEQ.NEXTVAL
		, #{qcContent}
		, SYSDATE
		, #{qcFileName}
		, 0
		, NVL((SELECT QCREF FROM QUESTION_COMMENT WHERE QCSEQ=#{qcSeq}),0)
		, NVL((SELECT QCSTEP FROM QUESTION_COMMENT WHERE QCSEQ=#{qcSeq}) + 1,0)
		, NVL((SELECT QCDEPTH FROM QUESTION_COMMENT WHERE QCSEQ=#{qcSeq}) + 1,0)
		)
	</insert>
	
	<!-- 질문과답변 댓글에 답글달면서 부모글 번호조정 -->
	<update id="questionCommentAnswerStep" parameterType="com.decolab.wanza.dto.QuestionCommentDTO">
		UPDATE QUESTION_COMMENT
		SET QCSTEP = QCSTEP + 1
		WHERE QCREF = (SELECT QCREF FROM QUESTION_COMMENT WHERE QCSEQ=#{qcSeq})
		AND QCSTEP >= (SELECT QCSTEP FROM QUESTION_COMMENT WHERE QCSEQ=#{qcSeq}) 
	</update>
		
	<!-- 질문과답변 조회수 -->
	<insert id="questionReadCountUp" parameterType="com.decolab.wanza.dto.QuestionDTO">
		UPDATE QUESTION
		SET QUESTIONREADCOUNT = QUESTIONREADCOUNT + 1
		WHERE QUESTIONSEQ = #{questionSeq}
	</insert>
	
</mapper>



  