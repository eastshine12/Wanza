<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  

  
<mapper namespace="com.decolab.wanza.dao.OrderDAO">

<!-- 장바구니 추가 -->
<insert id="addCart" parameterType="com.decolab.wanza.dto.CartDTO">
	INSERT INTO CART
	VALUES (#{cartClassify}, #{userSeq}, #{productSeq}, #{selectOption}, #{quantity}, #{price}, SYSDATE, 0)
</insert>


<!-- 장바구니에 이미 담겨있는지 확인 -->
<select id="checkCart" parameterType="com.decolab.wanza.dto.CartDTO" resultType="int">
	SELECT NVL(COUNT(*),0)
	FROM CART
	WHERE USERSEQ=#{userSeq} AND PRODUCTSEQ=#{productSeq} AND CARTSTATUS IN (0,1)
</select>


<!-- 유저별 장바구니 리스트 가져오기 -->
<select id="getCartList" resultType="com.decolab.wanza.dto.CartDTO">
	SELECT CARTCLASSIFY, C.USERSEQ, C.PRODUCTSEQ, SELECTOPTION, QUANTITY, PRICE, CARTDATE, CARTSTATUS,
        P.PRODUCTNAME, P.PRODUCTMAKER, P.PRODUCTFILENAME
	FROM CART C, PRODUCTIONS P
	WHERE C.PRODUCTSEQ=P.PRODUCTSEQ AND CARTCLASSIFY=#{cartClassify} AND CARTSTATUS IN (0,1)
	ORDER BY CARTDATE ASC
</select>


<!-- 장바구니 아이템 삭제 -->
<delete id="deleteCart" parameterType="com.decolab.wanza.dto.CartDTO">
	DELETE FROM CART
	WHERE CARTCLASSIFY=#{cartClassify} AND PRODUCTSEQ=#{productSeq}
</delete>

<!-- 장바구니 분류번호 2 변경  -->
<update id="checkedOrder" parameterType="com.decolab.wanza.dto.CartDTO">
	UPDATE CART
	SET CARTSTATUS=2
	WHERE CARTCLASSIFY=#{cartClassify} AND PRODUCTSEQ=#{productSeq}
</update>

<!-- 장바구니 분류번호 1 변경  -->
<update id="checkedIn" parameterType="com.decolab.wanza.dto.CartDTO">
	UPDATE CART
	SET CARTSTATUS=1
	WHERE CARTCLASSIFY=#{cartClassify} AND PRODUCTSEQ=#{productSeq}
</update>

<!-- 장바구니 분류번호 0 변경  -->
<update id="checkedOut" parameterType="com.decolab.wanza.dto.CartDTO">
	UPDATE CART
	SET CARTSTATUS=0
	WHERE CARTCLASSIFY=#{cartClassify} AND PRODUCTSEQ=#{productSeq}
</update>

<!-- 장바구니에서 수량 변경  -->
<update id="changeQuantity" parameterType="com.decolab.wanza.dto.CartDTO">
	UPDATE CART
	SET QUANTITY=#{quantity}
	WHERE CARTCLASSIFY=#{cartClassify} AND PRODUCTSEQ=#{productSeq}
</update>


<!-- 결제페이지 장바구니 리스트 가져오기 -->
<select id="getPaymentList" resultType="com.decolab.wanza.dto.CartDTO">
	SELECT CARTCLASSIFY, C.USERSEQ, C.PRODUCTSEQ, SELECTOPTION, QUANTITY, PRICE, CARTDATE, CARTSTATUS,
        P.PRODUCTNAME, P.PRODUCTMAKER, P.PRODUCTFILENAME
	FROM CART C, PRODUCTIONS P
	WHERE C.PRODUCTSEQ=P.PRODUCTSEQ AND CARTCLASSIFY=#{cartClassify} AND CARTSTATUS=1
	ORDER BY CARTDATE ASC
</select>


<!-- 신규 주소지 추가 -->
<insert id="addAddress" parameterType="com.decolab.wanza.dto.AddressDTO">
	INSERT INTO ADDRESS
	VALUES(SEQ_ADDRESS.NEXTVAL,#{userSeq},#{addressName},#{address},#{receiveUser},#{receivePhone})
</insert>


<!-- 나의 주소지 리스트 -->
<select id="getAddressList" parameterType="com.decolab.wanza.dto.AddressDTO" resultType="com.decolab.wanza.dto.AddressDTO">
	SELECT A.ADDRESSSEQ, A.USERSEQ, A.ADDRESSNAME, A.ADDRESS, A.RECEIVEUSER, A.RECEIVEPHONE, U.DEFAULTADDRESS
	FROM ADDRESS A, USERS U
	WHERE A.USERSEQ=U.USERSEQ AND A.USERSEQ=#{userSeq}
	ORDER BY ADDRESSSEQ ASC
</select>


<!-- 기본 주소지 설정 -->
<update id="updateDefaultAddress" parameterType="com.decolab.wanza.dto.AddressDTO">
	UPDATE USERS
	SET DEFAULTADDRESS=#{defaultAddress}
	WHERE USERSEQ=#{userSeq}
</update>


<!-- 결제완료 ORDER 테이블 삽입 -->
<insert id="addOrder" parameterType="com.decolab.wanza.dto.OrderDTO">
	INSERT INTO ORDERS
	VALUES (SEQ_ORDER.NEXTVAL, #{userSeq}, #{addressSeq}, #{productAmount}, #{deliveryAmount}, #{totalAmount}, 
			#{amountType}, SYSDATE, #{useMileage}, #{saveMileage}, 0, #{orderMessage})
</insert>


<!-- orderSeq 가져오기 -->
<select id="getOrderSeq" parameterType="com.decolab.wanza.dto.OrderDTO" resultType="int">
	SELECT ORDERSEQ
	FROM (SELECT * FROM ORDERS WHERE USERSEQ=#{userSeq} ORDER BY ORDERSEQ DESC)
	WHERE ROWNUM=1
</select>


<!-- purchase_product 테이블 DB 삽입 -->
<insert id="addPurchase" parameterType="com.decolab.wanza.dto.OrderDTO">
	INSERT INTO PURCHASE_PRODUCT
	VALUES (SEQ_PURC_PROD.NEXTVAL, #{orderSeq}, #{productSeq}, #{userSeq}, #{selectOption}, #{quantity}, #{price}, SYSDATE, 0)
</insert>


<!-- 유저 포인트 적립, 사용 -->
<update id="purchaseMileage" parameterType="com.decolab.wanza.dto.OrderDTO">
	UPDATE USERS
	SET MILEAGE=MILEAGE+#{saveMileage}
	<if test="useMileage>0">
	-#{useMileage}
	</if>
	WHERE USERSEQ=#{userSeq}
</update>

<!-- 주문현황 카운트하여 가져오기-->
<select id="getMyOrderStatusCount" parameterType="com.decolab.wanza.dto.MyPageDTO" resultType="com.decolab.wanza.dto.MyPageDTO">
	SELECT ORDERSTATUS, COUNT(*) ORDERSTATUSCOUNT FROM ORDERS WHERE USERSEQ=#{userSeq} GROUP BY ORDERSTATUS ORDER BY ORDERSTATUS
</select>
<!-- SELECT ORDERSTATUS, ORDERSEQ FROM ORDERS WHERE USERSEQ=#{userSeq} ORDER BY ORDERSTATUS, ORDERSEQ -->

<!-- 유저별 주문정보 리스트 조건별로 가져오기-->
<select id="getMyOrderList" parameterType="com.decolab.wanza.dto.MyPageDTO" resultType="com.decolab.wanza.dto.MyPageDTO">
	SELECT O.ORDERSEQ,O.USERSEQ,ORDERSTATUS,PRODUCTAMOUNT,DELIVERYAMOUNT,TOTALAMOUNT,ORDERDATE,
       	   COUNT(*) OVER(PARTITION BY O.ORDERSEQ) ORDERSTATUSCOUNT,
           C.PRODUCTSEQ,SELECTOPTION,QUANTITY,PRICE,REVIEWSTATUS,
           PRODUCTNAME,PRODUCTMAKER,PRODUCTFILENAME,PRODUCTDEL
	FROM ORDERS O, PURCHASE_PRODUCT C, PRODUCTIONS P
	WHERE O.ORDERSEQ=C.ORDERSEQ AND C.PRODUCTSEQ=P.PRODUCTSEQ
	<if test='userSeq neq null and userSeq neq ""'>AND O.USERSEQ=#{userSeq}</if>
	<if test='searchPeriod neq null and searchPeriod neq "" and searchPeriod gte 0'>AND ORDERDATE BETWEEN SYSDATE-#{searchPeriod} AND SYSDATE</if>
	<if test='orderStatus neq null and orderStatus neq "" and orderStatus gte 0 and orderStatus neq 2'>AND ORDERSTATUS=#{orderStatus}</if>
	<if test='orderStatus neq null and orderStatus neq "" and orderStatus eq 2'>AND (ORDERSTATUS=2 OR ORDERSTATUS=7)</if>
	ORDER BY ORDERSEQ DESC
</select>


<!-- 주문완료 페이지 구매내역 가져오기 -->
<select id="getOrderData" parameterType="com.decolab.wanza.dto.MyPageDTO" resultType="com.decolab.wanza.dto.MyPageDTO">
	SELECT O.ORDERSEQ,O.USERSEQ,ORDERSTATUS,PRODUCTAMOUNT,DELIVERYAMOUNT,TOTALAMOUNT,ORDERDATE,USEMILEAGE,
	       COUNT(*) OVER(PARTITION BY O.ORDERSEQ) ORDERSTATUSCOUNT,
	       C.PRODUCTSEQ,SELECTOPTION,QUANTITY,PRICE,REVIEWSTATUS,
	       PRODUCTNAME,PRODUCTMAKER,PRODUCTFILENAME,PRODUCTDEL
	FROM ORDERS O, PURCHASE_PRODUCT C, PRODUCTIONS P
	WHERE O.ORDERSEQ=C.ORDERSEQ AND C.PRODUCTSEQ=P.PRODUCTSEQ AND O.ORDERSEQ=#{orderSeq}
</select>

<!-- 주문완료 배송지 정보 가져오기 -->
<select id="getOrderAddress" parameterType="com.decolab.wanza.dto.AddressDTO" resultType="com.decolab.wanza.dto.AddressDTO">
	SELECT ADDRESSNAME, ADDRESS, RECEIVEUSER, RECEIVEPHONE, ORDERMESSAGE
	FROM ORDERS O, ADDRESS A
	WHERE O.ADDRESSSEQ=A.ADDRESSSEQ AND O.ORDERSEQ=#{orderSeq}
</select>

<!-- 주문상세 페이지 구매내역 가져오기 -->
<select id="getMyOrderDetail" parameterType="com.decolab.wanza.dto.MyPageDTO" resultType="com.decolab.wanza.dto.MyPageDTO">
	SELECT O.ORDERSEQ,ORDERSTATUS,PRODUCTAMOUNT,DELIVERYAMOUNT,TOTALAMOUNT,ORDERDATE, AMOUNTTYPE,USEMILEAGE, ORDERMESSAGE,
	       O.USERSEQ,EMAIL,USERNAME,NICKNAME,PHONE,
	       C.PRODUCTSEQ,SELECTOPTION,QUANTITY,PRICE,REVIEWSTATUS,
	       PRODUCTNAME,PRODUCTMAKER,PRODUCTFILENAME,PRODUCTDEL
	FROM ORDERS O, PURCHASE_PRODUCT C, PRODUCTIONS P, USERS U
	WHERE O.ORDERSEQ=C.ORDERSEQ AND C.PRODUCTSEQ=P.PRODUCTSEQ AND O.USERSEQ=U.USERSEQ AND O.ORDERSEQ=#{orderSeq}
</select>

</mapper>