<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.decolab.wanza.dao.AdminDAO">

<select id="getDeliveryStatusList" resultType="com.decolab.wanza.dto.admin.AdminDeliveryStatusDTO">
	SELECT O.ORDERSEQ, ORDERSTATUS, ORDERDATE, PRODUCTNAME, PRODUCTQUANTITY, TOTALQUANTITY, SUBSTR(ADDRESS,1,INSTR(ADDRESS,' ',1,2)-1) DELIVERYADDRESS, USERNAME, NICKNAME, PHONE, TOTALAMOUNT, USEMILEAGE, AMOUNTTYPE
	FROM ORDERS O, ADDRESS A, USERS U, 
         (SELECT ORDERSEQ, PRODUCTNAME, TOTALQUANTITY, PRODUCTQUANTITY
          FROM PRODUCTIONS P,(SELECT PRODUCTSEQ, ORDERSEQ, ROW_NUMBER() OVER(PARTITION BY ORDERSEQ ORDER BY PRICE) RNUM,
		                             COUNT(PRODUCTSEQ) OVER(PARTITION BY ORDERSEQ) PRODUCTQUANTITY,
		                             SUM(QUANTITY) OVER(PARTITION BY ORDERSEQ) TOTALQUANTITY
                              FROM PURCHASE_PRODUCT) R
          WHERE P.PRODUCTSEQ=R.PRODUCTSEQ AND RNUM=1) R
	WHERE O.ADDRESSSEQ=A.ADDRESSSEQ AND O.USERSEQ=U.USERSEQ AND O.ORDERSEQ=R.ORDERSEQ
	ORDER BY ORDERDATE DESC
</select>

<select id="getStoryTagList" resultType="com.decolab.wanza.dto.admin.AdminStoryTagDTO">
	SELECT DISTINCT C.CARDSEQ, C.CARDTITLE, C.CARDCONTENT, C.USERSEQ, C.CARDREADCOUNT, C.CARDDATE, C.CARDFILENAME,
        C.CARDDEL, U.NICKNAME, CF.LIKECOUNT, 
        (SELECT NVL(COUNT(CC.PRODUCTSEQ), 0) FROM CARD_COORDINATES CC WHERE C.CARDSEQ=CC.CARDSEQ(+) GROUP BY CC.CARDSEQ) AS TAGCOUNT
	FROM CARD_COLLECTIONS C, USERS U,
	    (SELECT CARDSEQ, NVL(COUNT(*), 0) LIKECOUNT FROM CARD_FAVORITE GROUP BY CARDSEQ) CF
	WHERE C.USERSEQ=U.USERSEQ AND C.CARDSEQ=CF.CARDSEQ(+)
	ORDER BY C.CARDDATE DESC
</select>

<select id="getSearchProductionList" parameterType="com.decolab.wanza.dto.ProductDTO" resultType="com.decolab.wanza.dto.ProductDTO">
	SELECT PRODUCTSEQ, PRODUCTNAME, PRODUCTCONTENT, PRODUCTPRICE, PRODUCTDISCOUNT, PRODUCTMAKER, PRODUCTFILENAME, PRODUCTRATING
	FROM PRODUCTIONS
	<if test="searchText != null">
	WHERE PRODUCTNAME LIKE '%'||#{searchText}||'%'
	</if>
	ORDER BY PRODUCTNAME
</select>



<select id="getProductImg" parameterType="com.decolab.wanza.dto.ProductDTO" resultType="com.decolab.wanza.dto.ProductDTO">
	SELECT PRODUCTNAME, PRODUCTFILENAME
	FROM PRODUCTIONS
	WHERE PRODUCTSEQ=#{productSeq}
</select>


<insert id="insertLocationTag" parameterType="com.decolab.wanza.dto.admin.AdminStoryTagDTO">
	INSERT INTO CARD_COORDINATES
	VALUES(#{cardSeq}, #{productSeq}, #{locationX}, #{locationY})
</insert>


<select id="getProductTag" parameterType="com.decolab.wanza.dto.admin.AdminStoryTagDTO" resultType="com.decolab.wanza.dto.admin.AdminStoryTagDTO">
	SELECT CARDSEQ, CC.PRODUCTSEQ, LOCATIONX, LOCATIONY, P.PRODUCTNAME, P.PRODUCTPRICE, P.PRODUCTFILENAME
	FROM CARD_COORDINATES CC, PRODUCTIONS P
	WHERE CC.PRODUCTSEQ=P.PRODUCTSEQ AND CARDSEQ=#{cardSeq}
</select>

<delete id="deleteTag" parameterType="com.decolab.wanza.dto.admin.AdminStoryTagDTO">
	DELETE FROM CARD_COORDINATES
	WHERE CARDSEQ=#{cardSeq} AND PRODUCTSEQ=#{productSeq}
</delete>

<insert id="addProduct" parameterType="com.decolab.wanza.dto.ProductDTO">
	INSERT INTO PRODUCTIONS(PRODUCTSEQ, PRODUCTNAME, PRODUCTCONTENT, PRODUCTPRICE, PRODUCTDISCOUNT, PRODUCTMAKER, PRODUCTFILENAME, PRODUCTRATING, PRODUCTDATE)
	VALUES (SEQ_PRODUCT.NEXTVAL, #{productName}, #{productContent}, #{productPrice}, #{productDiscount}, #{productMaker}, #{productFileName}, 0, SYSDATE)
</insert>

<insert id="addProductTag" parameterType="com.decolab.wanza.dto.ProductDTO">
	INSERT INTO PRODUCTION_TAG
	VALUES (#{productSeq}, #{largeCategory}, #{mediumCategory}, #{smallCategory})
</insert>

<insert id="addProductOption" parameterType="com.decolab.wanza.dto.ProductOptionDTO">
	INSERT INTO PRODUCTION_OPTION
	VALUES (#{productSeq}, #{optionSeq}, #{optionTitle}, #{optionContent}, #{optionPrice})
</insert>

<select id="getRecentAddProductSeq" resultType="int">
	SELECT PRODUCTSEQ
	FROM (SELECT * FROM PRODUCTIONS ORDER BY PRODUCTDATE DESC)
	WHERE ROWNUM=1
</select>


<select id="getProductQuestionList" resultType="com.decolab.wanza.dto.ProductQuestionDTO">
	SELECT PRODUCTQNASEQ, Q.PRODUCTSEQ, Q.USERSEQ, PURCHASESEQ, PRODUCTQCONTENT, PRODUCTACONTENT, PRODUCTQNADATE, PRODUCTQNADEL, NICKNAME, P.PRODUCTNAME
	FROM PRODUCTION_QUESTION Q, USERS U, PRODUCTIONS P
	WHERE Q.USERSEQ=U.USERSEQ AND Q.PRODUCTSEQ=P.PRODUCTSEQ AND PRODUCTQNADEL=0
	ORDER BY PRODUCTQNADATE DESC
</select>


<update id="addProductAnswer" parameterType="com.decolab.wanza.dto.ProductQuestionDTO">
	UPDATE PRODUCTION_QUESTION
	SET PRODUCTACONTENT=#{productAContent}
	WHERE PRODUCTQNASEQ=#{productQnASeq}
</update>

</mapper>
  